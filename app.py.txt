import streamlit as st
from PyPDF2 import PdfReader
from wordcloud import WordCloud, STOPWORDS
import matplotlib.pyplot as plt
import re

# ------------- Helpers -----------------

def extract_pdf_text(uploaded_file):
    """
    Extract text from all pages of an uploaded PDF file.
    """
    reader = PdfReader(uploaded_file)
    all_text = ""
    for page in reader.pages:
        txt = page.extract_text()
        if txt:
            all_text += txt + "\n"
    return all_text


def split_into_paragraphs(text):
    """
    Split raw PDF text into 'paragraph-like' chunks.
    We treat a blank line as a separator.
    """
    lines = [ln.strip() for ln in text.splitlines()]
    paragraphs = []
    current = []

    for ln in lines:
        if ln == "":
            if current:
                paragraphs.append(" ".join(current))
                current = []
        else:
            current.append(ln)

    if current:
        paragraphs.append(" ".join(current))

    return paragraphs


def filter_paragraphs(paragraphs, keywords, match_all=False):
    """
    Return paragraphs that contain ANY or ALL of the given keywords.
    Matching is case-insensitive.
    """
    if not keywords:
        return []

    key_lowers = [k.lower() for k in keywords]

    matched = []
    for p in paragraphs:
        p_low = p.lower()
        if match_all:
            if all(k in p_low for k in key_lowers):
                matched.append(p)
        else:
            if any(k in p_low for k in key_lowers):
                matched.append(p)

    return matched


def generate_wordcloud(text, extra_stopwords=None):
    """
    Generate a WordCloud object from text.
    """
    stopwords = set(STOPWORDS)
    if extra_stopwords:
        stopwords |= {w.lower() for w in extra_stopwords}

    wc = WordCloud(
        width=800,
        height=400,
        background_color="white",
        stopwords=stopwords
    ).generate(text)
    return wc

# ------------- Streamlit UI -----------------

def main():
    st.title("PDF Keyword Explorer & Word Cloud (Maruti Annual Report)")
    st.write(
        "Upload the annual report PDF, enter one or more keywords, "
        "and this app will show paragraphs containing those keywords "
        "and build a word cloud from them."
    )

    # PDF upload
    uploaded_pdf = st.file_uploader("Upload Annual Report (PDF)", type=["pdf"])

    # Keywords input
    keywords_input = st.text_input(
        "Enter keywords (comma-separated)",
        help="Example: patent, investment, crore"
    )

    match_type = st.radio(
        "Match paragraphs that contain:",
        ("Any of the keywords", "All of the keywords")
    )

    if uploaded_pdf is not None and keywords_input.strip():
        with st.spinner("Extracting text from PDF..."):
            raw_text = extract_pdf_text(uploaded_pdf)

        if not raw_text.strip():
            st.error("Could not extract any text from the PDF.")
            return

        paragraphs = split_into_paragraphs(raw_text)
        st.write(f"Total paragraphs detected: **{len(paragraphs)}**")

        # Process keywords
        # Split on comma or semicolon
        keywords = [k.strip() for k in re.split(r"[;,]", keywords_input) if k.strip()]

        if not keywords:
            st.warning("Please enter at least one valid keyword.")
            return

        match_all = (match_type == "All of the keywords")
        matched_paragraphs = filter_paragraphs(paragraphs, keywords, match_all=match_all)

        st.subheader("Matching Paragraphs")
        st.write(
            f"Found **{len(matched_paragraphs)}** paragraph(s) "
            f"matching **{match_type.lower()}**."
        )

        if matched_paragraphs:
            # Display paragraphs
            for i, p in enumerate(matched_paragraphs, start=1):
                st.markdown(f"**Paragraph {i}:**")
                st.write(p)
                st.markdown("---")

            # Word cloud from matched paragraphs
            all_matched_text = " ".join(matched_paragraphs)

            st.subheader("Word Cloud from Matching Paragraphs")
            try:
                wc = generate_wordcloud(all_matched_text, extra_stopwords=keywords)
                fig, ax = plt.subplots(figsize=(10, 5))
                ax.imshow(wc, interpolation="bilinear")
                ax.axis("off")
                st.pyplot(fig)
            except ValueError:
                st.warning("Not enough text to generate a word cloud.")
        else:
            st.warning("No paragraphs matched the given keywords.")

    else:
        st.info("Upload a PDF and enter keywords to begin.")

if __name__ == "__main__":
    main()
